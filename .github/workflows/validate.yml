name: Validate Schema and Examples

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    paths:
      - 'examples/**'
      - 'schema/**'

jobs:
  validate-schema:
    name: Validate JSON Schema
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSONC Schema Syntax
        run: |
          echo "üîç Checking JSONC schema syntax..."
          jq empty schema/workout-share-schema.jsonc
          echo "‚úÖ JSONC schema is valid"

      - name: Validate JSON Schema Syntax
        run: |
          echo "üîç Checking JSON schema syntax..."
          jq empty schema/workout-share-schema.json
          echo "‚úÖ JSON schema is valid"

      - name: Check Schema Sync
        run: |
          echo "üîç Checking if JSON schema is up to date..."
          jq '.' schema/workout-share-schema.jsonc > schema/workout-share-schema.json.tmp
          if ! diff -q schema/workout-share-schema.json schema/workout-share-schema.json.tmp; then
            echo "‚ùå JSON schema is out of sync with JSONC schema"
            echo "üí° Run 'task regenerate-schema' and commit the result"
            exit 1
          fi
          echo "‚úÖ JSON schema is up to date with JSONC source"

  validate-examples:
    name: Validate Example Workouts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install workout-share-validator
        run: |
          echo "üì¶ Installing workout-share-validator..."
          pip install workout-share-validator

      - name: Validate Examples
        run: |
          echo "üîç Validating example workout files..."
          find examples/ -name "*.yaml" -exec echo "Validating {}" \; -exec workout-share-validator {} --schema schema/workout-share-schema.json \;
          echo "‚úÖ All examples validated successfully"
